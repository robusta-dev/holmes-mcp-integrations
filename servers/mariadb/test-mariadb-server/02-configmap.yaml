apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-config
  namespace: mariadb
data:
  my.cnf: |
    [mysqld]
    # Basic Settings
    port = 3306
    bind-address = 0.0.0.0
    max_connections = 200

    # Character Set
    character-set-server = utf8mb4
    collation-server = utf8mb4_unicode_ci

    # InnoDB Settings
    innodb_buffer_pool_size = 1G
    innodb_log_file_size = 256M
    innodb_flush_log_at_trx_commit = 2
    innodb_flush_method = O_DIRECT
    innodb_file_per_table = 1

    # Slow Query Log (for troubleshooting)
    slow_query_log = 1
    slow_query_log_file = /var/log/mysql/slow-query.log
    long_query_time = 2
    log_queries_not_using_indexes = 1

    # General Query Log (disabled by default, enable for debugging)
    general_log = 0
    general_log_file = /var/log/mysql/general.log

    # Error Log
    log_error = /var/log/mysql/error.log
    log_warnings = 2

    # Performance Schema (for diagnostics)
    performance_schema = ON
    performance_schema_consumer_events_statements_current = ON
    performance_schema_consumer_events_statements_history = ON
    performance_schema_consumer_events_statements_history_long = ON
    performance_schema_consumer_events_waits_current = ON
    performance_schema_consumer_events_waits_history = ON
    performance_schema_consumer_events_waits_history_long = ON

    # Deadlock Detection
    innodb_print_all_deadlocks = 1
    innodb_lock_wait_timeout = 50

    # Connection Monitoring
    max_connect_errors = 100
    connect_timeout = 10

    # Query Cache (disabled in MariaDB 10.1+, but keeping for reference)
    query_cache_size = 0
    query_cache_type = 0

    [client]
    default-character-set = utf8mb4

    [mysql]
    default-character-set = utf8mb4